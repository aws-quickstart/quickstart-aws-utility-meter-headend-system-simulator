// Include any postdeployment steps here, such as steps necessary to test that the deployment was successful. If there are no postdeployment steps, leave this file empty.

== Postdeployment steps

=== Output values

After you launch {partner-product-short-name}, refer to the following output values located on the *Outputs* tab of the stack, as shown in <<outputs1>> below.

[#outputs1]
.Outputs for {partner-product-short-name} on AWS
image::../docs/deployment_guide/images/outputs.png[Outputs]

* *apiGatewayInvokeURL*: \https://<id>.execute-api.<region>.amazonaws.com/prod
* *SecretARN*: arn:aws:secretsmanager:<region>:<account>:secret:<stackname>/sftp/private_key-<id>
* *SecretName*: <stackname>/sftp/private_key
* *SftpServerAddress*: <id>.server.transfer.<region>.amazonaws.com
* *SftpUserName*: sftp-user

=== Verifying meter data generation
If you launched the optional Device Data Generator, records will be added to Amazon Timestream at the interval you defined at stack creation. To check this:
. Sign in to the AWS Management Console and open the https://us-east-1.console.aws.amazon.com/timestream/home?region=us-east-1#databases[Amazon Timestream console^]. 
. From the left navigation pane, choose *Query editor*.
. Run the below query. If the `devices` database and `readings` table values were changed during launch of {partner-product-short-name}, substitute your custom values.

.Amazon Timestream query to get min and max dates for records
[source,sql]
----
select
	min(time) time_min,
    max(time) time_max
from devices.readings
----

The results of the query should look similar to <<outputs2>>, below.
[#outputs2]
.Min/max SQL query results for {partner-product-short-name} on AWS
image::../docs/deployment_guide/images/sql_query_results.png[Outputs]

=== Interacting with REST API endpoints
When interacting with the {partner-product-short-name} REST API, use the output value from `apiGatewayInvokeURL` as the base URL, as shown in <<outputs1>> . +
Example: `{apiGatewayInvokeURL}`

==== Paginated smart meter readings
* *readings_endpoint*: readings
* *start_date*: 2023-02-27 16:00:00.000000
* *end_date*: 2023-02-27 16:40:00.000000
* *page_size*: 100

To fetch paginated readings from the REST API, `/readings` must be appended to the `apiGatewayInvokeURL`. In addition, the following parameters are required:

.Readings GET parameters
* `start_date` - Required date representing the start time from which to return smart meter readings.
* `page_size` - Optional number of records to return in each response. Default is 10.
* `offset` - Optional value used to return subsequent records after initial results.

The initial readings GET calls to the {partner-product-short-name} REST API should look like the following example: +
----
{apiGatewayInvokeURL}/{readings_endpoint}?start_date={start_date}&page_size={page_size}
----

See an example response below with the first and last record in the response.

.Example response of initial readings GET calls
[source,json]
----
{
  "filter_params": {
    "start_date": "2023-02-27 16:00:00.000000",
    "offset": 0
  },
  "results": {
    "records_total": 100,
    "last_offset": 100,
    "last_date": "2023-02-27 16:00:00.000000"
  },
  "records": [
    {
        "offset": 1,
        "time": "2023-02-27 16:00:00.000000",
        "arrival_time": "2023-02-27 16:00:00.000000",
        "device_id": "0001b33e-0898-33a6-ac1d-82b59b904034",
        "measure_name": "readings",
        "load": 18,
        "crrnt": 88.926,
        "pf": 0.918,
        "kva": 19.257,
        "kw": 17.674,
        "vltg": 0.217
    },
    ...
    {
        "offset": 100,
        "time": "2023-02-27 16:00:00.000000",
        "arrival_time": "2023-02-27 16:00:00.000000",
        "device_id": "00040f4a-f316-3114-bef0-504a37fbfbc4",
        "measure_name": "readings",
        "load": 12,
        "crrnt": 44.314,
        "pf": 0.913,
        "kva": 9.273,
        "kw": 8.464,
        "vltg": 0.209
    }
  ]
}
----

For subsequent calls for additional pages, supply the last offset value in the request, as shown below. +
----
{apiGatewayInvokeURL}/{readings_endpoint}?start_date={start_date}&page_size={page_size}&offset=100
----

See an example response below. Continue repeating the pattern of passing in the `last_ofsset` value for subsequent pages of results. When the `records_total` is less than the request offset value, or the number of records is 0, there are no more results to process.

.Example response of subsequent readings GET call
[source,json]
----
{
  "filter_params": {
    "start_date": "2023-02-27 16:00:00.000000",
    "offset": 100
  },
  "results": {
    "records_total": 100,
    "last_offset": 200,
    "last_date": "2023-02-27 16:00:00.000000"
  },
  "records": [
    {
        "offset": 101,
        "time": "2023-02-27 16:00:00.000000",
        "arrival_time": "2023-02-27 16:00:00.000000",
        "device_id": "00a0f4b9-c962-3c30-ae64-1a7e9313da75",
        "measure_name": "readings",
        "load": 15,
        "crrnt": 9.556,
        "pf": 0.958,
        "kva": 2.021,
        "kw": 1.936,
        "vltg": 0.212
    },
    ...
    {
        "offset": 200,
        "time": "2023-02-27 16:00:00.000000",
        "arrival_time": "2023-02-27 16:00:00.000000",
        "device_id": "011e2268-8ec6-3e78-b84e-96425c1b5d50",
        "measure_name": "readings",
        "load": 16,
        "crrnt": 67.688,
        "pf": 0.951,
        "kva": 15.083,
        "kw": 14.35,
        "vltg": 0.223
    }
  ]
}
----

==== Bulk meter readings files
* *readingsfile_endpoint*: readings/file

To request a bulk readings file, make a POST request by appending `/readings/file` to the `apiGatewayInvokeURL` URL, as shown below. +
----
{apiGatewayInvokeURL}/{readingsfile_endpoint}
----

The body of the post should include `start_date` and `end_date`, as shown below:

.Readings/file POST body
[source,json]
----
{
    "start_date": "2023-02-27 16:00:00.000000",
    "end_date": "2023-02-27 16:40:00.000000"
}
----

The REST API returns a `request_id` and `status` for the request. The lifecycle statuses of a file request are "queued" > "submitted" > "running" > "completed" or "failed".

.Example response from POST
[source,json]
----
{
    "request_id": "55e3059d-6274-4d97-89a8-40ca93bcd084",
    "status": "queued"
}
----

Using the `request_id` from the previous call, send a GET request to the `/readings/file` endpoint with a `request_id` parameter, as shown below.
----
{apiGatewayInvokeURL}/{readingsfile_endpoint}?request_id=55e3059d-6274-4d97-89a8-40ca93bcd084
----

The response returns the current status, as well as a `record_count` to signify the number of records that are contained in the file. When the file request is complete, the status is `completed` and the `sftp_location` is present, as shown in the example below.

.Example response from GET to readings/file resource
[source,json]
----
{
    "request_id": "55e3059d-6274-4d97-89a8-40ca93bcd084",
    "status": "completed",
    "sftp_location": "55e3059d-6274-4d97-89a8-40ca93bcd084/run-1664371535713-part-r-00000.gz",
    "record_count": 2920000
}
----

=== Downloading readings files
Download readings files from the SFTP file transfer service (provided by the AWS Transfer Family) by authenticating with the private certificate stored in AWS Secrets Manager. For demonstration purposes, we'll use the AWS Command Line Interface (AWS CLI) to retrieve the secret to a local file, and then use the certificate to download the file to our local machine.

==== Retrieving the secret to a file
Substitute `<SecretValue>` for the value displayed in <<outputs1>>.

.AWS CLI command to export secret value to a file
[source,console]
----
$ aws secretsmanager get-secret-value --secret-id <SecretValue> --output text --query SecretString > private.pem
----

.Change file permissions to 400 to make it usable
[source,console]
----
$ chmod 400 private.pem
----

==== Authenticating with the secret
Authenticate to the SFTP service using the `SftpUserName` and `SftpServerAddress`, as shown in <<outputs1>>, as well as with the certificate. See the example command below:

[source,console]
----
$ sftp -i private.pem <SftpUserName>@<SftpSereverAddress>
----

==== Downloading file
When authenticated, type `get` followed by the `sftp_location`, as demonstrated below.

[source,console]
----
$ get 55e3059d-6274-4d97-89a8-40ca93bcd084/run-1664371535713-part-r-00000.gz
----